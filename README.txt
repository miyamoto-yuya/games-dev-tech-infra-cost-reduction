================================================================================
                     AWS インフラコスト削減ツール
================================================================================

概要：
AWS費用削減のためのリソース分析・最適化提案ツール。
EC2/RDS/DocumentDB/ElastiCache のCPU使用率を分析し、
スケールダウン提案と月額コスト削減額を自動計算します。

================================================================================
                              利用方法
================================================================================

【方法1】ブラウザから分析（推奨）
-------------------------------------------------
1. Lambda Function URLにアクセス
2. アカウントを選択して「SSO ログイン」
3. 別タブで認証を完了 → 「認証完了を確認」
4. 「分析を実行」ボタンをクリック

※ SSO認証なしでも Lambda のIAMロールで実行可能


【方法2】CLI出力
-------------------------------------------------
python check.py --profile YOUR_PROFILE --stdout

================================================================================
                              出力形式
================================================================================

ブラウザの表示形式：

┌──────────────────────────────────────────────────────────────────────────────┐
│ 名前 │ ID │    現状                │    変更提案        │ CPU    │AIコメント│
│      │    │ タイプ│台数│月額│EBS.. │ 提案タイプ│月額│削減額 │ AvgMax│Max │        │
├──────────────────────────────────────────────────────────────────────────────┤
│ web1 │... │t3.lg │ 2 │$121│gp3.. │ t3.md    │$60 │-$61/月│ 15% │ 40%│過剰ｽﾍﾟｯｸ│
│ api1 │... │t3.md │ 1 │$30 │gp3.. │ -        │ -  │  -    │ 45% │ 70%│適正    │
│ db1  │... │t3.xl │ 1 │$120│gp3.. │ -        │ -  │  -    │ 85% │ 95%│ｽﾍﾟｯｸ不足│
└──────────────────────────────────────────────────────────────────────────────┘

【判定基準】
- CPU AvgMax < 40%  → 過剰スペック → スケールダウン提案
- CPU AvgMax 40-70% → 適正 → 変更不要
- CPU AvgMax > 70%  → スペック不足 → コメントのみ

【スケールダウン提案ロジック】
- 同一ファミリー内でサイズダウン（例: t3.large → t3.medium）
- 予測CPU使用率が40-70%に収まる最適サイズを選択
- ファミリー変更（r6g→c5等）は提案しない（互換性考慮）

================================================================================
                           アーキテクチャ
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│                          ブラウザ                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ SSO認証 → リソース表示 → スケールダウン提案 → コピー機能 │   │
│  └─────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────┐
│                    Lambda Function URL                         │
│              (HTML配信 + API + SSO認証処理)                    │
└───────┬───────────────┬───────────────┬───────────────────────┘
        │               │               │
        ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ Bedrock       │ │ AgentCore     │ │ CloudWatch    │
│ (Nova Lite)   │ │ (MCP Server)  │ │ Metrics       │
│               │ │               │ │               │
│ AI分析        │ │ 価格取得      │ │ CPU使用率     │
│ サマリー生成  │ │ スケールダウン│ │ 30日分取得    │
│               │ │ 提案計算      │ │               │
└───────────────┘ └───────┬───────┘ └───────────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │ AWS Pricing   │
                  │ API           │
                  └───────────────┘

================================================================================
                          MCPサーバー ツール
================================================================================

AgentCore上で動作するMCPサーバーが提供するツール：

【get_instance_price】
  インスタンスタイプの時間単価を取得
  対応: EC2, RDS (Aurora), ElastiCache (Redis), DocumentDB

【get_batch_recommendations】★メイン使用
  複数インスタンスの一括スケールダウン提案
  - CPU使用率から予測CPUを計算
  - 月額削減額を自動計算
  - 同一ファミリー内でサイズダウン

【get_batch_prices】
  複数インスタンスタイプの価格を一括取得

================================================================================
                           セットアップ
================================================================================

【前提条件】
- AWS CLI設定済み
- Terraform インストール済み
- Python 3.11+
- Bedrock Nova Lite モデルアクセス有効

【デプロイ手順】
1. Terraformでインフラ作成
   cd terraform
   terraform init
   terraform apply

2. MCPサーバーをAgentCoreにデプロイ
   cd mcp_server
   ./deploy.sh

3. Lambda Function URLにアクセス

================================================================================
                           コスト
================================================================================

【1回の実行コスト（概算）】
- Bedrock Nova Lite: 約 $0.0001
- Lambda実行: 約 $0.000001
- AgentCore: 約 $0.0001

合計: 約 $0.0002/回 (約0.03円/回)

================================================================================
                           ファイル構成
================================================================================

.
├── check.py                 # ローカル実行スクリプト
├── lambda_function/
│   └── handler.py           # Lambda関数（HTML + API + SSO認証）
├── mcp_server/
│   ├── server.py            # MCP Server（価格取得 + スケールダウン計算）
│   ├── Dockerfile           # MCPサーバー用Dockerファイル
│   └── deploy.sh            # デプロイスクリプト
├── terraform/
│   ├── providers.tf         # AWSプロバイダ設定
│   ├── lambda.tf            # Lambda定義
│   ├── iam.tf               # IAMロール・ポリシー
│   ├── agentcore.tf         # AgentCore/ECR/Cognito設定
│   └── variables.tf         # 変数定義
└── README.txt               # このファイル

================================================================================
                           トラブルシューティング
================================================================================

【SSO ログインできない】
→ AWS IAM Identity Center の設定を確認
→ SSO_PROFILES (handler.py) にプロファイルが登録されているか確認

【スケールダウン提案が表示されない】
→ CPU AvgMax が40%以上の場合は「適正」判定で提案なし
→ 最小構成（t3.nano等）の場合は提案なし

【AgentCore/MCP接続エラー】
→ MCP_RUNTIME_ARN が正しいか確認
→ Lambda IAMロールに bedrock-agentcore:InvokeAgentRuntime 権限があるか確認

【Bedrock エラー】
→ Nova Lite モデルアクセスを確認
→ Lambda IAMロールに bedrock:InvokeModel 権限があるか確認

================================================================================
