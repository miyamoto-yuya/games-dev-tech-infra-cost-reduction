================================================================================
                     AWS インフラコスト削減ツール
================================================================================

概要：
AWS費用削減のためのリソース分析・最適化提案ツール。
EC2/RDS/DocumentDB/ElastiCache のCPU使用率を分析し、
AIがインスタンスサイジングの最適化を提案します。

================================================================================
                              利用方法
================================================================================

【方法1】ブラウザから分析（推奨）
-------------------------------------------------
Lambda Function URLにアクセスして「分析を実行」ボタンをクリック。

1. ブラウザでLambda Function URLにアクセス
2. 「分析を実行」ボタンをクリック
3. 結果が表示されます：
   - 現状のインスタンス情報と月額コスト
   - AI提案（スケールダウン可能なインスタンス）
   - CPU使用率


【方法2】CLI出力
-------------------------------------------------
python check.py --profile YOUR_PROFILE --stdout

================================================================================
                              出力形式
================================================================================

ブラウザの表示形式：

┌──────────────────────────────────────────────────────────────────────────────┐
│ 名前 │ ID │    現状                │    変更提案        │ CPU    │AIコメント│
│      │    │ タイプ│台数│月額│EBS.. │ 提案タイプ│月額│削減額 │ AvgMax│Max │        │
├──────────────────────────────────────────────────────────────────────────────┤
│ web1 │... │t3.lg │ 2 │$121│gp3.. │ t3.md    │$60 │-$61/月│ 15% │ 40%│過剰ｽﾍﾟｯｸ│
│ api1 │... │t3.md │ 1 │$30 │gp3.. │ -        │ -  │  -    │ 45% │ 70%│適正    │
│ db1  │... │t3.xl │ 1 │$120│gp3.. │ -        │ -  │  -    │ 85% │ 95%│ｽﾍﾟｯｸ不足│
└──────────────────────────────────────────────────────────────────────────────┘

【カラム説明】
- 現状: 現在のインスタンス情報とコスト
- 変更提案: AIが提案するスケールダウン先（コスト削減目的のみ）
- CPU AvgMax: 30日間の5分平均の最大値（判定に使用）
- CPU Max: 30日間の5分最大値の最大値（参考値）
- AIコメント: 過剰スペック/適正/スペック不足

【判定基準】
- CPU AvgMax < 30%  → 過剰スペック → スケールダウン提案
- CPU AvgMax 30-70% → 適正 → 変更不要
- CPU AvgMax > 70%  → スペック不足 → コメントのみ（変更提案なし）

================================================================================
                           アーキテクチャ
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                         ユーザー                                             │
│           ┌───────────────┐      ┌───────────────┐                          │
│           │ check.py      │      │ ブラウザ      │                          │
│           │ (ローカル実行) │      │ (結果表示)    │                          │
│           └───────┬───────┘      └───────▲───────┘                          │
│                   │ リソース収集          │ 結果表示                         │
│                   ▼                       │                                  │
│           ┌───────────────────────────────┴─────────────────────────────┐   │
│           │               Lambda Function URL                           │   │
│           │         (HTML配信 + AI分析API)                              │   │
│           └───────────────────────────────┬─────────────────────────────┘   │
└───────────────────────────────────────────│─────────────────────────────────┘
                                            │
              ┌─────────────────────────────┼─────────────────────────────┐
              ▼                             ▼                             ▼
    ┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
    │ Amazon Bedrock  │         │ AgentCore MCP   │         │ AWS Pricing API │
    │ (Nova Lite)     │         │ Server          │         │                 │
    │                 │         │                 │         │                 │
    │ AI分析・提案生成 │ ◀────── │ 価格情報取得    │ ◀────── │ リアルタイム価格 │
    └─────────────────┘         └─────────────────┘         └─────────────────┘

【コンポーネント】
- Lambda Function     : フロントエンドHTML + バックエンドAPI
- Lambda Function URL : 認証なしHTTPエンドポイント
- Bedrock Nova Lite   : AI分析（約$0.0001/回）
- AgentCore MCP       : リモートMCPサーバー（価格情報取得）
- CloudWatch Logs     : Lambdaログ（7日保持）
- S3                  : Terraformステート保存

================================================================================
                           セットアップ
================================================================================

【前提条件】
- AWS CLI設定済み
- Terraform インストール済み
- Python 3.11+
- Bedrock Nova Lite モデルアクセス有効

【デプロイ手順】
1. Terraformでインフラ作成
   cd terraform
   terraform init
   terraform apply

2. Lambda Function URLが出力されます
   lambda_function_url = "https://xxx.lambda-url.ap-northeast-1.on.aws/"

【ローカル実行】
# 基本実行（ブラウザ自動オープン）
python check.py --profile YOUR_PROFILE --open

# オプション
--profile, -p  : AWSプロファイル名
--open         : 結果をブラウザで自動表示
--stdout, -s   : 標準出力に表示
--output, -o   : ファイルに出力
--quiet, -q    : 進捗非表示

================================================================================
                           コスト
================================================================================

【1回の実行コスト（概算）】
- Bedrock Nova Lite: 約 $0.0001 (入力1000トークン + 出力500トークン)
- Lambda実行: 約 $0.000001
- CloudWatch: 約 $0.000001

合計: 約 $0.0001/回 (約0.015円/回)

================================================================================
                           ファイル構成
================================================================================

.
├── check.py                 # ローカル実行スクリプト
├── lambda_function/
│   └── handler.py           # Lambda関数（HTML + API）
├── mcp_server/
│   ├── server.py            # MCP Server（価格情報取得）
│   └── Dockerfile           # MCPサーバー用Dockerファイル
├── terraform/
│   ├── providers.tf         # AWSプロバイダ設定
│   ├── lambda.tf            # Lambda定義
│   ├── iam.tf               # IAMロール・ポリシー
│   ├── agentcore.tf         # AgentCore/ECR/Cognito設定
│   └── variables.tf         # 変数定義
└── README.txt               # このファイル

================================================================================
                           トラブルシューティング
================================================================================

【Lambda Function URLでForbiddenエラー】
→ terraform apply を再実行してパーミッションを追加

【AI分析が失敗する】
→ Bedrock Nova Liteモデルアクセスを確認
→ Lambda実行ロールにbedrock:InvokeModel権限があるか確認

【ブラウザが自動で開かない】
→ WSL2/DevContainer環境では手動でURLをコピーしてブラウザで開く

【MFA認証エラー】
→ aws sts get-session-token で一時認証情報を取得
→ または aws sso login でSSO認証

================================================================================
